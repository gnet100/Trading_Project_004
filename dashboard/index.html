<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧬 DNA Research Dashboard - Trading Project 004</title>

    <!-- Lightweight Charting Library (TradingView alternative) -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

    <!-- Axios for API calls -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Chart.js for additional charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            direction: rtl;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .title {
            font-size: 2.5em;
            font-weight: bold;
            color: #4a5568;
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            font-size: 1.1em;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-label {
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9em;
        }

        select, input, button {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .chart-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 15px;
            text-align: center;
        }

        #main-chart {
            height: 500px;
            width: 100%;
            border-radius: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9em;
        }

        .indicators-panel {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .indicator-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .indicator-item:last-child {
            border-bottom: none;
        }

        .indicator-toggle {
            width: 50px;
            height: 25px;
            background: #e2e8f0;
            border-radius: 25px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .indicator-toggle.active {
            background: #667eea;
        }

        .indicator-toggle::before {
            content: '';
            position: absolute;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .indicator-toggle.active::before {
            transform: translateX(25px);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 1.1em;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #c53030;
        }

        .success {
            background: #c6f6d5;
            color: #2f855a;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2f855a;
        }

        .chat-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .chat-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            resize: vertical;
            min-height: 60px;
            direction: rtl;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }

            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="title">🧬 DNA Research Dashboard</h1>
            <p class="subtitle">Trading Project 004 - מחקר סטטיסטי מתקדם על נתוני מסחר</p>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <label class="control-label">סימבול</label>
                <select id="symbolSelect">
                    <option value="MSTR">MSTR</option>
                    <option value="AAPL">AAPL</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">מסגרת זמן</label>
                <select id="timeframeSelect">
                    <option value="1min">1 דקה</option>
                    <option value="5min">5 דקות</option>
                    <option value="15min" selected>15 דקות</option>
                    <option value="1hour">שעה</option>
                    <option value="4hour">4 שעות</option>
                    <option value="daily">יומי</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">תאריך התחלה</label>
                <input type="date" id="startDate">
            </div>

            <div class="control-group">
                <label class="control-label">תאריך סיום</label>
                <input type="date" id="endDate">
            </div>

            <div class="control-group">
                <label class="control-label">פעולות</label>
                <button id="loadDataBtn">טען נתונים</button>
            </div>

            <div class="control-group">
                <label class="control-label">ניתוח DNA</label>
                <button id="analyzeDnaBtn">נתח DNA</button>
            </div>
        </div>

        <!-- Main Charts Container -->
        <div class="charts-container">
            <!-- Main Chart -->
            <div class="chart-panel">
                <h3 class="chart-title">גרף נרות יפניים עם אינדיקטורים</h3>
                <div id="main-chart"></div>
            </div>

            <!-- Indicators Panel -->
            <div class="chart-panel">
                <h3 class="chart-title">אינדיקטורים זמינים</h3>
                <div id="indicators-list">
                    <div class="loading">טוען אינדיקטורים...</div>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid" id="stats-grid">
            <!-- Stats will be populated dynamically -->
        </div>

        <!-- Chat Panel -->
        <div class="chat-panel">
            <h3 class="chart-title">שאל שאלות על הנתונים</h3>
            <textarea id="questionInput" class="chat-input" placeholder="לדוגמה: מה Win Rate של MSTR במסגרת זמן של 15 דקות? איך מתפרש ADX של 25?"></textarea>
            <button id="askQuestionBtn" style="margin-top: 10px; width: 100%;">שאל שאלה</button>
            <div id="answer-area" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        // Global variables
        let chart;
        let candlestickSeries;
        let volumeSeries;
        let currentData = [];
        let availableIndicators = [];
        let activeIndicators = new Set(['bollinger_bands']);

        // API base URL
        const API_BASE = 'http://localhost:8000';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            loadAvailableIndicators();
            setupEventListeners();
            setDefaultDates();
        });

        function initializeChart() {
            const chartContainer = document.getElementById('main-chart');

            chart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.clientWidth,
                height: 500,
                layout: {
                    backgroundColor: '#ffffff',
                    textColor: '#333',
                },
                grid: {
                    vertLines: {
                        color: '#e1e1e1',
                    },
                    horzLines: {
                        color: '#e1e1e1',
                    },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#cccccc',
                },
                timeScale: {
                    borderColor: '#cccccc',
                    timeVisible: true,
                    secondsVisible: false,
                },
            });

            // Create candlestick series
            candlestickSeries = chart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderVisible: false,
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350',
            });

            // Create volume series
            volumeSeries = chart.addHistogramSeries({
                color: '#26a69a',
                priceFormat: {
                    type: 'volume',
                },
                priceScaleId: 'volume',
            });

            chart.priceScale('volume').applyOptions({
                scaleMargins: {
                    top: 0.7,
                    bottom: 0,
                },
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                chart.applyOptions({
                    width: chartContainer.clientWidth,
                    height: 500
                });
            });
        }

        function setupEventListeners() {
            document.getElementById('loadDataBtn').addEventListener('click', loadData);
            document.getElementById('analyzeDnaBtn').addEventListener('click', analyzeDNA);
            document.getElementById('askQuestionBtn').addEventListener('click', askQuestion);

            // Auto-refresh when changing symbol or timeframe
            document.getElementById('symbolSelect').addEventListener('change', loadData);
            document.getElementById('timeframeSelect').addEventListener('change', loadData);
        }

        function setDefaultDates() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);

            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
        }

        async function loadAvailableIndicators() {
            try {
                const response = await axios.get(`${API_BASE}/indicators/available`);
                availableIndicators = response.data;
                renderIndicatorsList();
            } catch (error) {
                console.error('Error loading indicators:', error);
                document.getElementById('indicators-list').innerHTML =
                    '<div class="error">שגיאה בטעינת אינדיקטורים</div>';
            }
        }

        function renderIndicatorsList() {
            const container = document.getElementById('indicators-list');

            if (availableIndicators.length === 0) {
                container.innerHTML = '<div class="loading">לא נמצאו אינדיקטורים</div>';
                return;
            }

            const indicatorGroups = {};
            availableIndicators.forEach(indicator => {
                if (!indicatorGroups[indicator.category]) {
                    indicatorGroups[indicator.category] = [];
                }
                indicatorGroups[indicator.category].push(indicator);
            });

            let html = '';
            Object.keys(indicatorGroups).forEach(category => {
                html += `<h4 style="margin: 15px 0 10px 0; color: #667eea;">${getCategoryName(category)}</h4>`;

                indicatorGroups[category].forEach(indicator => {
                    const isActive = activeIndicators.has(indicator.column_name);
                    html += `
                        <div class="indicator-item">
                            <div>
                                <strong>${indicator.name}</strong><br>
                                <small style="color: #718096;">${indicator.description}</small>
                            </div>
                            <div class="indicator-toggle ${isActive ? 'active' : ''}"
                                 onclick="toggleIndicator('${indicator.column_name}', this)">
                            </div>
                        </div>
                    `;
                });
            });

            container.innerHTML = html;
        }

        function getCategoryName(category) {
            const names = {
                'price': 'מחיר',
                'volume': 'נפח',
                'momentum': 'מומנטום',
                'volatility': 'תנודתיות',
                'trend': 'מגמה',
                'price_volume': 'מחיר + נפח',
                'correlation': 'קורלציה'
            };
            return names[category] || category;
        }

        function toggleIndicator(columnName, element) {
            if (activeIndicators.has(columnName)) {
                activeIndicators.delete(columnName);
                element.classList.remove('active');
            } else {
                activeIndicators.add(columnName);
                element.classList.add('active');
            }

            // Refresh chart if data is loaded
            if (currentData.length > 0) {
                updateChartIndicators();
            }
        }

        async function loadData() {
            const symbol = document.getElementById('symbolSelect').value;
            const timeframe = document.getElementById('timeframeSelect').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const loadBtn = document.getElementById('loadDataBtn');

            loadBtn.disabled = true;
            loadBtn.textContent = 'טוען...';

            try {
                const params = new URLSearchParams({
                    trading_hours_only: 'true',
                    min_quality: '95',
                    limit: '2000'
                });

                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);

                const response = await axios.get(`${API_BASE}/data/${symbol}/${timeframe}?${params}`);
                currentData = response.data.reverse(); // Reverse to get chronological order

                if (currentData.length === 0) {
                    throw new Error('לא נמצאו נתונים לטווח התאריכים שנבחר');
                }

                updateChart();
                updateStats();

                showMessage('✅ נתונים נטענו בהצלחה', 'success');

            } catch (error) {
                console.error('Error loading data:', error);
                showMessage(`❌ שגיאה בטעינת נתונים: ${error.message}`, 'error');
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'טען נתונים';
            }
        }

        function updateChart() {
            if (!currentData || currentData.length === 0) return;

            // Prepare candlestick data
            const candleData = currentData.map(item => ({
                time: new Date(item.timestamp).getTime() / 1000, // Convert to seconds
                open: item.open_price,
                high: item.high_price,
                low: item.low_price,
                close: item.close_price,
            }));

            // Prepare volume data
            const volumeData = currentData.map(item => ({
                time: new Date(item.timestamp).getTime() / 1000,
                value: item.volume,
                color: item.close_price >= item.open_price ? '#26a69a80' : '#ef535080',
            }));

            // Update chart
            candlestickSeries.setData(candleData);
            volumeSeries.setData(volumeData);

            // Add indicators
            updateChartIndicators();
        }

        function updateChartIndicators() {
            // Remove existing indicator lines (simplified - in real implementation, we'd track these)
            // Here we'd add Bollinger Bands, Moving Averages, etc.

            if (activeIndicators.has('bollinger_upper') && currentData[0]?.bollinger_upper) {
                const bollingerUpperData = currentData
                    .filter(item => item.bollinger_upper)
                    .map(item => ({
                        time: new Date(item.timestamp).getTime() / 1000,
                        value: item.bollinger_upper,
                    }));

                if (bollingerUpperData.length > 0) {
                    const upperLineSeries = chart.addLineSeries({
                        color: '#f50057',
                        lineWidth: 1,
                        title: 'Bollinger Upper',
                    });
                    upperLineSeries.setData(bollingerUpperData);
                }
            }
        }

        function updateStats() {
            const statsContainer = document.getElementById('stats-grid');

            if (!currentData || currentData.length === 0) {
                statsContainer.innerHTML = '<div class="loading">אין נתונים להצגת סטטיסטיקות</div>';
                return;
            }

            const totalBars = currentData.length;
            const avgVolume = currentData.reduce((sum, item) => sum + item.volume, 0) / totalBars;
            const avgQuality = currentData.reduce((sum, item) => sum + item.data_quality_score, 0) / totalBars;
            const priceRange = Math.max(...currentData.map(d => d.high_price)) - Math.min(...currentData.map(d => d.low_price));

            const stats = [
                { label: 'סה"כ ברים', value: totalBars.toLocaleString() },
                { label: 'נפח ממוצע', value: Math.round(avgVolume).toLocaleString() },
                { label: 'איכות ממוצעת', value: `${avgQuality.toFixed(1)}%` },
                { label: 'טווח מחירים', value: `$${priceRange.toFixed(2)}` }
            ];

            let html = '';
            stats.forEach(stat => {
                html += `
                    <div class="stat-card">
                        <div class="stat-value">${stat.value}</div>
                        <div class="stat-label">${stat.label}</div>
                    </div>
                `;
            });

            statsContainer.innerHTML = html;
        }

        async function analyzeDNA() {
            const symbol = document.getElementById('symbolSelect').value;
            const analyzeBtn = document.getElementById('analyzeDnaBtn');

            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'מנתח...';

            try {
                const response = await axios.get(`${API_BASE}/analysis/dna/${symbol}`);
                const dnaResults = response.data;

                if (dnaResults.length === 0) {
                    throw new Error('לא נמצאו נתוני DNA לניתוח');
                }

                displayDNAAnalysis(dnaResults);
                showMessage('✅ ניתוח DNA הושלם בהצלחה', 'success');

            } catch (error) {
                console.error('Error in DNA analysis:', error);
                showMessage(`❌ שגיאה בניתוח DNA: ${error.message}`, 'error');
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'נתח DNA';
            }
        }

        function displayDNAAnalysis(results) {
            const statsContainer = document.getElementById('stats-grid');

            let html = '';
            results.forEach(analysis => {
                html += `
                    <div class="stat-card">
                        <div class="stat-value">${analysis.win_rate}%</div>
                        <div class="stat-label">Win Rate - ${analysis.timeframe}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${analysis.total_signals}</div>
                        <div class="stat-label">סה"כ אותות - ${analysis.timeframe}</div>
                    </div>
                `;
            });

            statsContainer.innerHTML = html;
        }

        async function askQuestion() {
            const question = document.getElementById('questionInput').value.trim();
            const answerArea = document.getElementById('answer-area');
            const askBtn = document.getElementById('askQuestionBtn');

            if (!question) {
                showMessage('אנא הכנס שאלה', 'error');
                return;
            }

            askBtn.disabled = true;
            askBtn.textContent = 'חושב...';
            answerArea.innerHTML = '<div class="loading">מעבד את השאלה...</div>';

            try {
                // This would integrate with an AI service or analysis engine
                // For now, provide template responses based on question patterns
                const response = generateTemplateAnswer(question);

                answerArea.innerHTML = `
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-top: 10px;">
                        <strong>תשובה:</strong><br>
                        ${response}
                    </div>
                `;

            } catch (error) {
                answerArea.innerHTML = `<div class="error">שגיאה בעיבוד השאלה: ${error.message}</div>`;
            } finally {
                askBtn.disabled = false;
                askBtn.textContent = 'שאל שאלה';
            }
        }

        function generateTemplateAnswer(question) {
            const lowerQuestion = question.toLowerCase();

            if (lowerQuestion.includes('win rate') || lowerQuestion.includes('רווחיות')) {
                return 'Win Rate הוא אחוז העסקאות המנצחות מתוך כלל העסקאות. ערך של מעל 60% נחשב טוב. לחישוב מדויק, הרץ ניתוח DNA על הנתונים הרצויים.';
            }

            if (lowerQuestion.includes('adx')) {
                return 'ADX (Average Directional Index) מודד את חוזק המגמה. ערכים מעל 25 מצביעים על מגמה חזקה, מתחת ל-20 מצביעים על מגמה חלשה או אין מגמה.';
            }

            if (lowerQuestion.includes('bollinger') || lowerQuestion.includes('בולינגר')) {
                return 'סרטי בולינגר מראים תנודתיות המחיר. כאשר המחיר נוגע בסרט העליון - המחיר יכול להיות גבוה, כאשר נוגע בתחתון - המחיר יכול להיות נמוך.';
            }

            if (lowerQuestion.includes('volume') || lowerQuestion.includes('נפח')) {
                return 'נפח המסחר מצביע על התעניינות השוק. נפח גבוה עם עלייה במחיר מחזק את המגמה העולה, ולהיפך.';
            }

            return 'שאלה מעניינת! כרגע המערכת תומכת בשאלות בסיסיות על Win Rate, ADX, סרטי בולינגר ונפח מסחר. בעתיד תתווסף יכולת AI מתקדמת יותר לניתוח הנתונים.';
        }

        function showMessage(message, type) {
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '20px';
            messageDiv.style.right = '20px';
            messageDiv.style.zIndex = '1000';
            messageDiv.style.maxWidth = '400px';

            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>